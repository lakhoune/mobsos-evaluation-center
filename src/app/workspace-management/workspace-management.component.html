<mat-card id="header-card">
  <!-- service selection -->
  <mat-toolbar-row>
    <mat-form-field id="community-service-select">
      <mat-label>{{
        'success-modeling.select-application' | translate
      }}</mat-label>
      <mat-select
        [formControl]="serviceSelectForm"
        (selectionChange)="onServiceSelected($event.value)"
      >
        <mat-option
          *ngFor="let service of services$ | async"
          [value]="service"
        >
          {{ service.alias ? service.alias : service.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </mat-toolbar-row>
  <!-- workspace management -->
  <mat-toolbar-row id="edit-controls" *ngIf="showEditButton$ | async">
    <mat-slide-toggle
      labelPosition="before"
      [checked]="editMode$ | async"
      (toggleChange)="onEditModeChanged($event)"
      [disabled]="!(memberOfGroup$ | async)"
      [matTooltip]="
        (memberOfGroup$ | async)
          ? ('success-modeling.edit-tooltip' | translate)
          : ('success-modeling.edit-disabled-tooltip' | translate)
      "
    >
      {{ 'success-modeling.edit-mode-toggle' | translate }}
    </mat-slide-toggle>

    <ng-container *ngIf="editMode$ | async">
      <div id="workspace-controls">
        <button
          mat-icon-button
          [matMenuTriggerFor]="reqMenu"
          aria-label="Requirements Bazaar"
          matTooltip="{{
            'success-modeling.reqbaz.tooltip' | translate
          }}"
        >
          <mat-icon
            color="primary"
            svgIcon="reqbaz-logo"
            [matBadge]="
              numberOfRequirements === 0 ? null : numberOfRequirements
            "
          >
          </mat-icon>
        </button>

        <button
          mat-icon-button
          aria-label="Spectators"
          [matMenuTriggerFor]="groupMenu"
          matTooltip="{{
            'success-modeling.visitors.tooltip' | translate
          }}"
        >
          <mat-icon
            color="primary"
            [matBadge]="
              (visitorsExcpetUser$ | async)?.length === 0
                ? null
                : (visitorsExcpetUser$ | async)?.length
            "
            matBadgeColor="accent"
          >
            group
          </mat-icon>
        </button>

        <button
          mat-icon-button
          aria-label="Workspaces"
          [matMenuTriggerFor]="workspaceMenu"
          matTooltip="{{
            'success-modeling.workspaces.tooltip' | translate
          }}"
        >
          <mat-icon
            color="primary"
            [matBadge]="
              (workspacesForServiceExceptActive$ | async)?.length ===
              0
                ? null
                : (workspacesForServiceExceptActive$ | async)?.length
            "
            matBadgeColor="accent"
          >
            view_carousel
          </mat-icon>
        </button>
      </div>
    </ng-container>
  </mat-toolbar-row>
</mat-card>

<ng-container
  *ngIf="(user$ | async)?.profile?.preferred_username as username"
>
  <mat-card *ngIf="editMode$ | async" id="workspace-info">
    <div id="info-content">
      <mat-icon color="accent">info_outline</mat-icon>
      <span id="info-text">
        <span *ngIf="userIsOwner$ | async; else notUserWorkspace">
          {{ 'success-modeling.info.own-workspace' | translate }}
        </span>
      </span>
    </div>
  </mat-card>
</ng-container>

<!-- menu for Requirements Bazar -->
<mat-menu #reqMenu="matMenu">
  <mat-card-content class="card">
    <app-requirements-list
      [successModel]="successModel$ | async"
      (numberOfRequirements)="numberOfRequirements = $event.valueOf()"
    >
    </app-requirements-list>
  </mat-card-content>
</mat-menu>
<!-- menu for visitors -->
<mat-menu #groupMenu>
  <ng-container
    *ngIf="visitorsExcpetUser$ | async as foreign_visitors"
  >
    <mat-card-content class="card">
      <h3>{{ 'success-modeling.visitors.heading' | translate }}</h3>
      <div *ngIf="foreign_visitors?.length === 0" class="popover-row">
        {{ 'success-modeling.visitors.no-visitors' | translate }}
      </div>

      <div *ngFor="let visitor of foreign_visitors">
        {{ visitor.username }}
        <ng-container *ngIf="userIsOwner$ | async">
          <button
            *ngIf="visitor.role !== 'editor'"
            mat-icon-button
            matTooltip="{{
              'success-modeling.visitors.edit-role-description'
                | translate
            }}"
            matTooltipShowDelay="0"
            (click)="changeVisitorRole(visitor.username, 'editor')"
          >
            <mat-icon>create</mat-icon>
          </button>
          <button
            *ngIf="visitor.role !== 'spectator'"
            mat-icon-button
            matTooltip="{{
              'success-modeling.visitors.spectator-role-description'
                | translate
            }}"
            matTooltipShowDelay="0"
            (click)="changeVisitorRole(visitor.username, 'spectator')"
          >
            <mat-icon>remove_red_eye</mat-icon>
          </button>
        </ng-container>
      </div>
    </mat-card-content>
  </ng-container>
</mat-menu>
<!-- menu for workspace -->
<mat-menu #workspaceMenu>
  <ng-container
    *ngIf="
      workspacesForServiceExceptActive$ | async as other_workspaces
    "
  >
    <mat-card-content class="card">
      <h3>{{ 'success-modeling.workspaces.heading' | translate }}</h3>
      <div *ngIf="other_workspaces?.length === 0">
        {{ 'success-modeling.workspaces.no-workspaces' | translate }}
      </div>
      <div
        *ngFor="let workspace of other_workspaces"
        class="popover-row"
      >
        <span>
          {{ workspace.createdBy }}
          <strong
            *ngIf="
              workspace.createdBy ===
              (user$ | async).profile.preferred_username
            "
          >
            ({{
              'success-modeling.workspaces.your-workspace'
                | translate
            }})
          </strong>
        </span>
        <span>
          <button
            *ngIf="userIsOwner$ | async"
            mat-icon-button
            matTooltip="{{
              'success-modeling.workspaces.copy-workspace' | translate
            }}"
            matTooltipShowDelay="0"
            (click)="openCopyWorkspaceDialog(workspace.createdBy)"
          >
            <mat-icon>content_copy</mat-icon>
          </button>
          <button
            mat-icon-button
            matTooltip="{{
              'success-modeling.workspaces.go-to' | translate
            }}"
            matTooltipShowDelay="0"
            (click)="switchWorkspace(workspace.createdBy)"
          >
            <mat-icon>exit_to_app</mat-icon>
          </button>
        </span>
      </div>
    </mat-card-content>
  </ng-container>
</mat-menu>

<ng-template #notUserWorkspace>
  <ng-contiainer *ngIf="roleInWorkspace$ | async as role">
    {{ 'success-modeling.info.workspace-of' | translate }}
    <strong>{{ workspaceUser }}</strong
    >.
    <span *ngIf="role === 'spectator'">
      {{
        'success-modeling.info.workspace-rights-spectator' | translate
      }}
    </span>
    <span *ngIf="role === 'editor'">
      {{
        'success-modeling.info.workspace-rights-editor' | translate
      }}
    </span>
    {{
      'success-modeling.info.workspace-ask-owner-to-save' | translate
    }}
  </ng-contiainer>
</ng-template>
